---
title: "Individual Analysis"
author: "Dario Trujano Ochoa"
output: 
  pdf_document:
    keep_tex: yes
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
#setwd("C:/Users/Dario Trujano/Google Drive/Maestria/CIDE-2015/ExtraTime/ArticuloCitizenCandidate")
#setwd("D:/Dario/Box Sync/Maestria/CIDE-2015/ExtraTime/ArticuloCitizenCandidate")
setwd("D:/Dario/Dropbox/Citizen-Candidate/ArticleCitizenCandidate")
knitr::opts_knit$set(root.dir = normalizePath("D:/Dario/Dropbox/Citizen-Candidate/ArticleCitizenCandidate"))
library(pacman)
p_load(nleqslv)
p_load(dplyr)
p_load(tidyr)
p_load(ggplot2)
source("src/QRE_functions_2.R")
source("src/VotingRules.R")

```

# Data

Let's import some data bases previusly created from the treatments:

```{r}
getwd()
participants_305075 <- read.csv("data/participants_305075.csv")[,2:8]
colnames(participants_305075)[3:5] <- c("Left", "Center", "Right")
participants_203080 <- read.csv("data/participants_203080.csv")[,2:8]
colnames(participants_203080)[3:5] <- c("Left", "Center", "Right")
```

and now I merge them

```{r}
participants <- rbind(participants_305075,participants_203080)

treatments <- names(table(participants$Game))
treatments_names <- cbind.data.frame(treatments,
                          NewNames = c("PLCS","PLCA","PL","PH","RL","RH"))
```

#Graphs on Individual Behavior

With the next graphs, we visually analize hetereogeneity among participants. The entry porportion by individual and by relative position are displayed; each red line relate data from each participant.
For simplicity, we analize the bahavior according with the relative position, i.e., 1 stand for the left extreme candidate, 2 for that one in the middle, and  the extreme right candidate is represented by 3. The precise postiion depends of the treatment.

```{r, echo=FALSE}
par(mfrow=c(3,2))
for(t in treatments_names$treatments){
  # boxplot(participants[participants$Game==t,3:5], 
  #         main=treatments_names$NewNames[treatments_names$treatments==t])
  plot(c(0,1,0),col="white", 
       main=treatments_names$NewNames[treatments_names$treatments==t],
       ylab = "Entry Proportion",xlab = "Relative Position")
  for(j in 1:length(participants[participants$Game==t,3])){
    lines(1:3,participants[participants$Game==t,3:5][j,],col=rgb(1,0,0,1/4))
  }
}
```

The behavior displayed is very simmilar among participants within treatments. Some participants deviate from the general path, but they are rare. Also, we can see that the variance increases for the position that should not enter according with Nash prediction.

#Entry bias

We considered the hypothesis of a biased decision towards entry.

First, let us consider the parameters of the treatments:

```{r}
alpha = 0.1 
costs = c(5,5,5,20,5,20) #costs in treatments
benefit = 25
D = 40 # penalty if no one enters
# what everybody does
n = 3         # numer of players
Q_games = cbind(matrix(c(c(30, 50, 70),c(30, 50, 80),rep(c(20, 30, 80),4)),ncol=3,nrow=6,byrow = T))  # ideal points used in the experiment
parameters_games <-cbind(alpha, costs, benefit,D)
row.names(parameters_games) <- treatments
VotingRule <- c("Plurality Rule","Plurality Rule","Plurality Rule","Plurality Rule","Run-Off","Run-Off")
parameters_games2 <- data.frame(VotingRule,parameters_games,Q_games)
game_names <-  treatments_names$NewNames
row.names(parameters_games2) <- game_names
colnames(parameters_games2)[6:8] <- c("Left", "Center", "Right")
Equilibria <- data.frame(
  Games= game_names,
  OneCandidate= c(50,50,30,30,30,30),
  TwoCandidate= c("30, 70",NA, "20, 80",NA,NA,NA) )
```

Second, we get the proportion of entry by session. 

```{r,include=FALSE}
n_treatments <- length(treatments)
proportions <- {}
proportions_participants <- {}
expected_value_entry <- {}
exp_val_participants <- {}

for(t in 1:length(treatments)){
  treatment_sessions <- participants[participants$Game==treatments[t],]
  n_sessions <- length(table(treatment_sessions$Session))
  for(s in 1:n_sessions){ # all treatments had 3 sessions
    session_game <- treatment_sessions[treatment_sessions$Session==s,]
    proportions <- rbind(proportions,colMeans(session_game[,3:5],na.rm = T)) #columns 3:5 with the proportions
    #I do not consider NA: cases where participants did not played for some position
    #This only happen in game U, in two occasions, in the 20 position
    proportions_sessionGame <- matrix(replicate(length(session_game$Game),tail(proportions,1)),ncol = 3,byrow = T)
    proportions_participants <- rbind(proportions_participants,proportions_sessionGame)
    if(session_game$Game[1]%in%c("T","U")){ # different function depending on voting rule
      expected_value_entry <- 
      rbind(expected_value_entry, 
              as.vector(as.matrix(ex_payoffs(probs = tail(proportions,1),p = as.vector(parameters_games[t,]),q = Q_games[t,],FUN = RO))))
      exp_val_participants <- 
      rbind(exp_val_participants,
              matrix(replicate(length(session_game$Game),tail(expected_value_entry,1)),ncol = 6,byrow = T))
    }else{
      expected_value_entry <- 
        rbind(expected_value_entry, 
              as.vector(as.matrix(ex_payoffs(probs = tail(proportions,1),p = as.vector(parameters_games[t,]),q = Q_games[t,],FUN = PR))))
      exp_val_participants <- 
      rbind(exp_val_participants,
              matrix(replicate(length(session_game$Game),tail(expected_value_entry,1)),ncol = 6,byrow = T))
    }
  }
}

# Sessions
entry_proportions_by_session <- (proportions)
expected_value_entry <- as.data.frame(expected_value_entry)
names(expected_value_entry) <- c("LeftEntry", "CenterEntry","RightEntry","LeftPass", "CenterPass","RightPass")
optimal_sessions <- (expected_value_entry[,1:3]-expected_value_entry[,4:6])>0


#participant
exp_val_participants <- as.data.frame(exp_val_participants)
names(exp_val_participants) <- c("LeftEntry", "CenterEntry","RightEntry","LeftPass", "CenterPass","RightPass")
optimal_participants <- (exp_val_participants[,1:3]-exp_val_participants[,4:6])>0
optimal_participants<- as.data.frame(optimal_participants)
names(optimal_participants) <- c("ShouldLeftEntry", "ShouldCenterEntry","ShouldRightEntry")
```


Finally, we merge the proportion of entry, the proportion of entry by session, and the expected payoffs of entry by session in a single data base.

```{r}
str(entry_proportions_by_session)
write.csv(entry_proportions_by_session, "data/entry_proportions_by_session.csv")

participants <- cbind.data.frame(participants,exp_val_participants,optimal_participants) 
positions_should_entry <- c("ShouldLeftEntry", "ShouldCenterEntry","ShouldRightEntry")
positions_prop_entry <- names(participants[3:5])

errors <-  participants[positions_prop_entry]-
  participants[positions_should_entry] # there are 3 participants that no played some position
names(errors) <- paste("Errors",names(errors))

errors1 <- errors > 0 # they entry when should not
errors2 <- errors < 0 # they do not enter when they should 

Error1 <- rowSums(errors*errors1,na.rm = T) # when players never played some position there is NA
Error2 <- rowSums(errors*errors2,na.rm = T)

participants <- cbind(participants,errors,Error1,Error2)
str(participants)
write.csv(participants,file = "data/participants.csv")

```


#Biased towards entry

In order to anaize the errror bias, we considered the difference between the entry proportion and the optimal decision, e.g. if the optimal decision was to enter, and the proportion observed was $0.5$, we calculate a negative error of $0.5$. Then, a positive error indicates overentry, and negative subentry relative with the optimal decision. It can be seen that erros range from -1 to 1, and cero means optimal behavior.

We ran the analisis by position, as we saw a diference in the idividual behavior according with this variable. Also, we analized the treatment effect over error distributons. In each graph, a density was adjusted and data from the three positions are set for comparison.

```{r,include=FALSE}
Error_treatment <- participants %>% 
  select(starts_with("Errors ")) %>% 
  gather(key = Position,value = Errors) %>% 
  mutate(Position=factor(Position,levels = c("Errors Left","Errors Center","Errors Right")))
plot_t <- ggplot(data = Error_treatment,aes(x=Errors,fill=Position)) + 
  geom_density(alpha=.3)+
  scale_fill_manual( values = c("red","blue","green"))+
  labs(title= "Error Bias All Treatments")
```

```{r,echo=FALSE,message=FALSE}
print(plot_t)
```


In the graph that shows the joined behavior in all treatments by position, we can see that extreme positions are more commonly biased towards over entering, i.e., participants are prone to enter in those positions even against their interest. On the other hand, in central position, participants tend to make less mistakes and, if so, they enter less than predicted.

## Analysis by Treatment

In this section, we analize error distribution in the six treatments.

```{r, echo=FALSE,message=FALSE}
par(mfrow=c(3,2))
#there are missing values, but there are just 3
game_names <- data.frame(game_names)
row.names(game_names)<- treatments
for(t in treatments){
  Error_treatment <- subset(participants,Game==t) %>% 
    select(starts_with("Errors ")) %>% 
    gather(key = Position,value = Errors) %>% 
    mutate(Position=factor(Position,levels = c("Errors Left","Errors Center","Errors Right")))
  plot_t <- ggplot(data = Error_treatment,aes(x=Errors,fill=Position)) + 
    geom_density(alpha=.3)+
    scale_fill_manual( values = c("red","blue","green"))+
    labs(title=game_names[t,])
  
  pdf(paste("results/figures/errorDistribution",game_names[t,],".pdf",sep = ""))
  print(plot_t)
  dev.off()
  
  png(paste("results/figures/error_Distribution",game_names[t,],".png",sep = ""))
  print(plot_t)
  dev.off()
  
  assign(as.character(game_names[t,]),plot_t) 
  
  print(plot_t)
}

```

According with the graphs, treatmets PH, RL and RH display a similar behavior in general: overentry in the extreme positions, and less error in the central one. Among other treatments, there is more hetereogeneity. In the PLCS treatment, we observe that in extreme position participants make less mistakes, and error is uniformly distributed in central position.
In the PLCA treatment, there are less mistakes in the left position, and overentry in the right position. Finally, in the PL treatment we observe the opposite; more mistakes in the left positions, and more optimal behavior when participants were in the right position.

# Conclusion

There are differences in the error distributions along the tretments. This errors reflect the bahavior observed in comparisson with the Nash Equilibria. In all the treatment, but in PLCS, central position entering alone was predicted. As we saw in the first graphs, there are diferences in the entry rate between extreme positions along the treatments and the errors baheve accordingly; when an extreme position enter more than the other, the positive error is greater.


